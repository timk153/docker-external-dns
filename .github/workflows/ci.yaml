name: Continous Integration
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
permissions:
  checks: write
  pull-requests: write
jobs:
  quality_gateway:
    name: Quality Gateway
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        name: Checkout
      - uses: Amadevus/pwsh-script@97a8b21
        name: 'Docker: generating quality reports (testing & linting)'
        id: script
        with:
          script: |
            $identity = New-Guid
             $name = "docker-compose-external-dns.quality.$identity"
             docker build --target tests --tag $name .
             docker run -v /var/run/docker.sock:/var/run/docker.sock --name $name -a stdin -a stdout -a stderr $name
             mkdir output
             docker cp "$($name):/app/src" "./output/src"
             docker cp "$($name):/app/reports" "./output/reports"
             docker container rm $name
             docker image rm $name
      - uses: mikepenz/action-junit-report@db71d41
        name: Publish Test Report
        if: success() || failure()
        with:
          report_paths: './output/reports/*junit*.xml'
          fail_on_failure: true
          include_passed: true
      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@89d6c85
        with:
          project-token: ${{ secrets.CODACY_TOKEN }}
          coverage-reports: ./output/reports/*cobertura*.xml
      - uses: gaelgirodon/ci-badges-action@e2b7770
        name: Generate CI badges
        with:
          gist-id: 26bea053b867128f6f37f5aac0ddcf8b
          token: ${{ secrets.GIST_TOKEN }}
